<!doctype html>
<html>
	<head>
		<title>Unquantified</title>
		<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
		<script src="https://www.chartjs.org/chartjs-chart-financial/chartjs-chart-financial.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.js"></script>
		<style>
			.resetZoom {
				transition: background .25s,border-color .25s;
				background: rgba(40,44,52,.05);
				border: 1px solid transparent;
				border-radius: 6px;
				color: #3080d0;
				text-decoration: none!important;
				display: inline-block;
				font-size: .8rem;
				padding: 8px 16px;
				margin: 0 8px 8px 0;
				cursor: pointer;
				-webkit-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;

				margin-top: 12px;
				float: right;
			}
		</style>
		<script>
			"use strict";

			function loadData() {
				const request = {
					tickers: [
						"ES"
					],
					from: "2023-11-01T00:00:00+02:00",
					to: "2024-06-01T00:00:00+02:00",
					timeFrame: 1440
				};
				const json = JSON.stringify(request);
				const url = "/history";
				const options = {
					method: "POST",
					headers: {
						"Content-Type": "application/json"
					},
					body: json
				};
				fetch(url, options)
					.then(response => response.json())
					.then(historyResponse => drawChart(historyResponse))
					.catch(error => console.error(error));
			}

			function getTime(timeString) {
				const time = luxon.DateTime.fromISO(timeString);
				return time.valueOf();
			}

			function drawChart(historyResponse) {
				const div = document.createElement("div");
				div.style.width = "1500px";
				const canvas = document.createElement("canvas");
				div.appendChild(canvas);
				document.body.appendChild(div);
				const button = document.createElement("button");
				button.className = "resetZoom";
				button.textContent = "Reset zoom";
				div.appendChild(button);
				const context = canvas.getContext("2d");
				context.canvas.width = 1000;
				context.canvas.height = 500;
				const ticker = Object.keys(historyResponse.tickers)[0];
				const records = historyResponse.tickers[ticker];
				const barData = records.map(ohlc => {
					return {
						x: getTime(ohlc.time),
						o: ohlc.open,
						h: ohlc.high,
						l: ohlc.low,
						c: ohlc.close
					};
				});
				const datasets = [
					{
						label: ticker,
						data: barData
					}
				];
				const chart = new Chart(context, {
					type: "candlestick",
					data: {
						datasets: datasets
					},
					options: {
						plugins: {
							zoom: {
								pan: {
									enabled: true
								},
								zoom: {
									drag: {
										enabled: true
									},
									mode: "x",
								}
							}
						},
						transitions: {
							zoom: {
								animation: {
									duration: 0
								}
							}
						}
					}
				});
				console.log(chart);
				button.onclick = event => chart.resetZoom();
			}

			document.addEventListener("DOMContentLoaded", event => { 
				loadData();
			});
		</script>
	</head>
	<body>
	</body>
</html>